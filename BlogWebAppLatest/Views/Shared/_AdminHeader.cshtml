using BlogWebApp.Models
@using BlogWebApp.Models.IdentityModel
@using Microsoft.AspNetCore.Identity

@inject SignInManager<User> SignInManager
@inject UserManager<User> UserManager

@{
}
<!-- ======= Header ======= -->
<header id="header" class="header fixed-top d-flex align-items-center">

    <div class="d-flex align-items-center justify-content-between">
        <a href="#" class="logo d-flex align-items-center">
            <img src="~/assets/img/logo.png" alt="">
            <span class="d-none d-lg-block">  Admin Pannel</span>
        </a>
        <i class="bi bi-list toggle-sidebar-btn"></i>
    </div><!-- End Logo -->

  @*   <div class="search-bar">
        <form class="search-form d-flex align-items-center" method="POST" action="#">
            <input type="text" name="query" placeholder="Search" title="Enter search keyword">
            <button type="submit" title="Search"><i class="bi bi-search"></i></button>
        </form>
    </div><!-- End Search Bar --> *@

    <nav class="header-nav ms-auto">
        <ul class="d-flex align-items-center">

            <li class="nav-item d-block d-lg-none">
                <a class="nav-link nav-icon search-bar-toggle " href="#">
                    <i class="bi bi-search"></i>
                </a>
            </li><!-- End Search Icon-->

            <li class="nav-item dropdown">

                <a class="nav-link nav-icon notificationBell" role="button" data-bs-toggle="dropdown">
                    <i class="bi bi-bell"></i>
                    <span class="badge bg-danger badge-number">0  </span>
                </a><!-- End Notification Icon -->

                <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow notifications" style="max-height:420px; width:300px;  overflow-y:scroll;">
                    <li class="dropdown-header">
                        @* You have 4 new notifications *@
                       @*  <a href="#"><span class="badge rounded-pill bg-primary p-2 ms-2">View all</span></a> *@
                    </li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
@* 
                    <li class="notification-item">
                        <i class="bi bi-exclamation-circle text-warning"></i>
                        <div>
                            <h4>Lorem Ipsum</h4>
                            <p>Quae dolorem earum veritatis oditseno</p>
                            <p>30 min. ago</p>
                        </div>
                    </li>

                    <li>
                        <hr class="dropdown-divider">
                    </li> *@

                  

                   @*  <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li class="dropdown-footer">
                        <a href="#">Show all notifications</a>
                    </li> *@

                </ul><!-- End Notification Dropdown Items -->

            </li><!-- End Notification Nav -->

          @if (SignInManager.IsSignedIn(User))
            {
                var user = await UserManager.GetUserAsync(User);
                var role = await UserManager.GetRolesAsync(user);
                <li class="nav-item dropdown pe-3">

                <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
                        <img src="~/Uploads/@(@user?.ProfileUrl==null && @user?.ProfileUrl==""? "defaultPic.jpg": @user?.ProfileUrl)" alt="Profile" class="rounded-circle">
                        <span class="d-none d-md-block dropdown-toggle ps-2">@user?.DisplayName</span>
                </a><!-- End Profile Iamge Icon -->

                <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
                    <li class="dropdown-header">
                        <h6> @user?.Email </h6>
                        <span>@user?.Position</span> <br />
                            <span> <b> Role: </b>  @role.FirstOrDefault()</span>
                    </li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>

                    <li>
                            <a class="dropdown-item d-flex align-items-center" href="/dashboard/profile">
                            <i class="bi bi-person"></i>
                            <span>My Profile</span>
                        </a>
                    </li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>

                    <li>
                        <hr class="dropdown-divider">
                    </li>

                    <li>
                            <a class="dropdown-item d-flex align-items-center" href="/Account/Logout">
                            <i class="bi bi-box-arrow-right"></i>
                            <span>Sign Out</span>
                        </a>
                    </li>

                </ul> @* sfsd *@
            </li>  @* End Profile Nav *@
            }
        </ul>
    </nav> 

</header><!-- End Header -->


<script src="~/lib/jquery/dist/jquery.js"></script>
<script src="~/toastr/js/toastr.min.js"></script>
<script type="text/javascript">

    $(document).ready(function () {
        $.ajax({
            url: '/Notifications/GetNotification', 
            type: 'GET',
            success: function (data) {
                renderPosts(data.notifications, '.notifications');
            },
            error: function (xhr, status, error) {
                // Handle error
                $(".badge-number").text(0);
                console.error('Error fetching popular and TotalNotification posts:', error);
            }
        });
        function renderPosts(posts, containerSelector) {
      
            var $container = $(containerSelector);
            $container.empty();
            $(".badge-number").text(posts[0].totalNotification);

            $.each(posts, function (index, post) {
                console.log(post);
                console.log(posts);
                var postHtml = `
                            <li class="notification-item" id="${post.id}">
                               <a href="/blog-details?id=${post.blogId}">
                                       <img src="~/Uploads/${post.url}" alt="Profile" style="height:40px;width:40px;"  class="rounded-circle">
                                    <i class="bi bi-exclamation-circle text-success"></i>
                            <div>
                                    <h4>${post.username}</h4>
                                    <p>${post.body}</p>
                                    <p>${post.notificationDate}</p>
                            </div>
                            </a>
                        </li>

                        <li>
                            <hr class="dropdown-divider">
                        </li>
                `;

                $container.append(postHtml);
            });
        }

        $(".notificationBell").click(function () {
            var notificationIds = [];
            var noOFNoti = $(".badge-number").text().trim();
            if (noOFNoti== "0"){
                return;
            }
            $(".notifications").find(".notification-item").each(function () {
                var notificationId = parseInt($(this).attr("id")); 
                notificationIds.push(notificationId);
            });
         
            $.ajax({
                url: '/Notifications/UdpateNotificationStaus/',
                type: 'POST',
                contentType: "application/json",
                data: JSON.stringify(notificationIds),
                success: function (response) {
                    toastr.success('Notifiction Read.');
                },
                error: function (xhr, status, error) {
                    
                    @* toastr.error('Error'); *@
                }
            });
        });
    });

</script>